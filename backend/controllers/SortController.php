<?php/** * Created by PhpStorm. * User: asusa * Date: 2018/3/28/0028 * Author: Cary.He * Contact QQ  : 373889161($S$-Memory) * email: 373889161@qq.com * Time: 17:10 */namespace backend\controllers;use Yii;use backend\core\MY_Controller;use backend\models\Sort;use yii\helpers\ArrayHelper;class SortController extends MY_Controller{    /**     * @return string     * 文章分类列表     */    public function actionIndex()    {        $fun_help = new \Helpers();        $countries=Sort::find()->all();        $menu = $fun_help->gettree($countries,'pid','id','sort_name',1);        $nav = $fun_help->formenu($menu);        return $this->render('index', [            'nav' => $nav,        ]);    }    /**     * @return string|\yii\web\Response     * 创建文章分类     */    public function actionCreate()    {        $model = new Sort();        $fun_help = new \Helpers();        $model->is_nav=0;        $model->is_show=0;        //$model->scenario = 'create';    //设置 create 场景验证        $countries=Sort::find()->all();        $menu = $fun_help->gettree($countries,'pid','id','sort_name');        $nav = $fun_help->formenu($menu);        $listData=ArrayHelper::map($nav,'id','name'); //输出选择上级分类        if ($model->load(Yii::$app->request->post()) &&  $model->addmeg()) {            Yii::$app->session->setFlash('success','添加成功！');            return $this->redirect('index');  //跳转到提示页面        } else {            return $this->render('create', [                'model' => $model,                'listData' => $listData,            ]);        }    }    /**     * @param $id     * @return string|\yii\web\Response     * @throws \backend\core\NotFoundHttpException     * 编辑文章分类     */    public function actionEdit($id)    {        $fun_help = new \Helpers();        $model = $this->findSort($id);        if(!$model)        {            return $this->redirect('index');        }        $countries=Sort::find()->all();        $menu = $fun_help->gettree($countries,'pid','id','sort_name');        $nav = $fun_help->formenu($menu);        $listData=ArrayHelper::map($nav,'id','name'); //输出选择上级分类        if($model->load(Yii::$app->request->post())){            $selid = $fun_help->getsort($id,1);            $newarr = explode(',',$fun_help->returnid($selid));            if(in_array($model->pid,$newarr))            {                Yii::$app->session->setFlash('success','选择上级分类错误!');            }            else            {                $model->save();                Yii::$app->session->setFlash('success','更新成功!');                return $this->redirect('index');            }        }        return $this->render('edit',[            'model'=>$model,            'listData'=>$listData,        ]);    }    public function actionDelete($id)    {        $fun_help = new \Helpers();        $countries=Sort::find()->all();        $menu = $fun_help->get_tree($countries,'pid','id','sort_name',0,$id);        $article = Sort::find()->leftJoin('yii_article','yii_article.pid = yii_sort.id')            ->select('yii_sort.*,yii_article.*')            ->where(['yii_article.pid'=>$id])            ->all();        if($article)        {            Yii::$app->session->setFlash('success','分类下有数据不可以删除!');        }        else        {            if($menu){                //存在子节点　不可删除                Yii::$app->session->setFlash('success','不可以删除!');            }else{                //不存在子节点　可删除                $this->findSort($id)->delete();                Yii::$app->session->setFlash('success','删除成功!');            }        }        return $this->redirect(['index']);    }}